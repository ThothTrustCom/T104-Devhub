# T104 Applet APDU Guide #
The T104 Applet is responsible for the access to the low level drivers for the card's timeout settings, E-Ink display and the E-Wallet feature.

Certain features including the management of the E-Wallet feature as well as the card's timeout function maybe carried out via directly accessing the T104 Applet as a T104 Applet Administrator role.

A secure channel between the Host application (i.e. T104 Manager GUI console) and T104 applet has to be established before accessing the features and settings.

The Secure Channel Protocol as well as the APDUs for accessing the T104 Applet is given below.

## T104 Applet AID ##
    0x4B4D31303400

## T104 Secure Channel Protocol Key Agreement - A03 ##
The A03 SCP protocol uses a ephemeral-static ECDH key agreement protocol. The card applet hosts a long term static keypair while the Host Application dynamically generates an ephemeral keypair for the secure channel key agreement.

T104 Applet uses the following cryptographic primitives for Secure Channel negotiations and Secure Messaging.
* ECC SECP-256K1 for ECC public and private key
* KeyAgreement.ALG_EC_SVDP_DH_PLAIN for key agreement protocol
* Cipher.ALG_AES_CBC_PKCS5 for symmetric key encryption of messages
* MessageDigest.ALG_SHA_256 for hashing of messages and HMAC message authentication

The steps from Host Application (Host) to T104 Applet for negotiating the A03 Secure Channel is as follows:

1. Host generates ephemeral keypair and sends uncompressed public key in ASN.1 format `(0x04 || X || Y )` to the card applet. A total of 65 bytes are required with 32 bytes of X and Y each.
2. A Nonce for Secure Messaging is generated by hashing the host ephemeral public key followed by the T104 Applet public key and extracting the first 12 bytes.
    > `Nonce <-- First12Bytes(SHA256(HostPublicKey || T104PublicKey))`
3. A shared secret is created on the Host and T104 Applet by performing an ECDH and extracting the first 32 bytes (X coordinates) of the shared secret.
    > `X <-- First32Bytes(ECDH(PrivateKey == Host / Applet Private Key, PublicKey == Host / Applet
 Public Key))`
4. SHA-256 hash the 32 bytes X coordinates that was extracted as the session key.
    > `SessionKey <-- SHA256(X)`
5. Session OTP Key is generated by a second SHA-256 hash on the X coordinates.
    > `OTPKey <-- SHA256(SessionKey)`
6. Generate the OTP Code according to HOTP mode of RFC-4226.

Check the OTP Code the Host generated and the OTP Code displayed on the E-Ink screen.

## T104 Secure Channel Protocol Message Protection - A03 ##
Protected messages that are encrypted and authenticated occuring after a Key Agreement will use the following protocol. All plain messages are to be exactly 197 or less bytes before being encrypted and then authenticated. If the messages are more than 197 bytes, chunk them into portions of 197 bytes with the last message packet having the remainder bytes.

Two counters, one for the Host and one for the Applet exists on both sides. A `HostToApplet` and a `AppletToHost` counter are taken care of by both the Host and Applet in an ephemeral manner. Both starts with a counter of zero `0x0000` of data type `short`.

### Enveloping a Message from Host to Applet ###
1. Check to ensure session counters `HostToApplet` and `AppletToHost` are less than 65536 or `0xFFFF`. Host must manually execute another fresh Key Agreement if any counters are close to reaching maximum counter for any of the session counters. Ensure input message is of correct length.
2. Form encryption IV by concatenating `Nonce`, `HostToApplet` and `AppletToHost`, hashing them with SHA-256 and extracting the first 16 bytes.
    > `MessageIV <-- First16Bytes(SHA256( Nonce || HostToApplet || AppletToHost ))`
3. Encrypt message with Cipher.ALG_AES_CBC_PKCS5.
    > `CipherText <-- AES_CBC_PKCS5(Key == SessionKey, Message == Input, IV = MessageIV)`
4. Create a Message Hash by concatenating APDU `CLA`, `INS`, `P1`, `P2`, `MessageIV`, `CipherText`
    > `MessageHash <-- SHA256( CLA || INS || P1 || P2 || MessageIV || CipherText)`
5. MAC using `SessionKey` and `MessageHash`.
    > `MAC <-- HMACSHA256(Key == SessionKey, Message == MessageHash)`
6. Format enveloped message as follows:
	> `EnvelopedAPDUMessage <-- CLA || INS || P1 || P2 || LC == Length(CipherText) + Length(MAC) || Content == CipherText || MAC`
7. Increment `HostToApplet` counter once.
8. Send enveloped APDU message to T104 applet.

### Un-enveloping a Message from Applet to Host ###
1. Check to ensure session counters `HostToApplet` and `AppletToHost` are less than 65536 or `0xFFFF`. Host must manually execute another fresh Key Agreeement if any counters are close to reaching maximum counter for any of the session counters. Ensure input message is of correct length.
2. If returned length is only 2 bytes SW, increment `AppletToHost` counter and exit.
3. Form encryption IV by concatenating `Nonce`, `HostToApplet` and `AppletToHost`, hashing them with SHA-256 and extracting the first 16 bytes.
    > `MessageIV <-- First16Bytes(SHA256( Nonce || HostToApplet || AppletToHost ))`
4. Create a Response Hash by concatenating APDU `SW`, `MessageIV`, `CipherText`
    > `ResponseHash <-- SHA256( SW || MessageIV || CipherText)`
5. MAC using `SessionKey` and `ResponseHash` and compare received MAC and computed MAC. If successful matching of the MAC, proceed to step 6 and decrypt the `CipherText`.
    > `MAC <-- HMACSHA256(Key == SessionKey, Message == ResponseHash)`
6. Decrypt message with Cipher.ALG_AES_CBC_PKCS5.
    > `ResponseMessage <-- AES_CBC_PKCS5(Key == SessionKey, Message == CipherText, IV = MessageIV)`
7. Increment `AppletToHost` counter once regardless if the MAC was verified or not.

## Management APDUs ##
Please not that APDU commands marked with requiring secure APDU request will require encryption and authentication of APDU commands before sending them to the T104 applet. APDU responses marked with requiring secure APDU response will need to go through the un-enveloping process to verify the secure responses as well a optionally decrypt the response content if available.

### Retrieving T104 Applet Information ###
Retrieves the following information of the T104:
* Version of Applet
* Capability of Applet
* Supported User Type
* Supported SCP protocol
* Supported applet backup method
* Hardware Interaction method
* Applet login format
* Persistent memory space available (estimated)
* Transient resettable memory space available (estimated)
* Transient deselectable memory space available (estimated)
* Unique Hardware ID
    * Long term public key (SECP256K1 algorithm)

APDU Message Security:
<table border="1">
<tr>
<td>Require Enveloping Message</td>
<td>Require Un-enveloping Mesage</td>
</tr>
<tr>
<td>CONDITIONAL</td>
<td>CONDITIONAL</td>
</tr>
</table>
<br>

Request APDU:
<table border="1">
<tr>
<td>CLA</td>
<td>INS</td>
<td>P1</td>
<td>P2</td>
<td>LC</td>
<td>DATA</td>
<td>LE</td>
</tr>
<tr>
<td>88 (PLAIN)/ 84 (SECURE)</td>
<td>B2</td>
<td>00</td>
<td>00</td>
<td>00</td>
<td>N/A</td>
<td>N/A</td>
</tr>
</table>
<br>

Response APDU: \
Returns information about the card.
<br><br>
TLV is being used after the initial two byte version sequence. All TLV length are restricte to one byte length only.

A list of supported TLV tags:

    public static final byte TLV_TAG_HW_INFO = (byte) 0x01;
    public static final byte TLV_TAG_HW_CAP = (byte) 0x02;
    public static final byte TLV_TAG_HW_USR = (byte) 0x03;
    public static final byte TLV_TAG_HW_MEM_PERSIST = (byte) 0x04;
    public static final byte TLV_TAG_HW_MEM_TEMP_RST = (byte) 0x41;
    public static final byte TLV_TAG_HW_MEM_TEMP_DST = (byte) 0x42;
    public static final byte TLV_TAG_HW_ID = (byte) 0x05;
    public static final byte TLV_TAG_HW_ID_PUB = (byte) 0x51;
    public static final byte TLV_TAG_HW_ID_ATTEST = (byte) 0x52;
    public static final byte TLV_TAG_HW_SCP = (byte) 0x06;
    public static final byte TLV_TAG_HW_BK = (byte) 0x07;
    public static final byte TLV_TAG_HW_INTERACT = (byte) 0x08;
    public static final byte TLV_TAG_HW_CRED_FORMAT = (byte) 0x09;
    public static final byte TLV_TAG_AOC_CRED_ID = (byte) 0x0A;
    public static final byte TLV_TAG_AOC_AUXDATA = (byte) 0x0B;
    public static final byte TLV_OBJ_FIELD_ID = (byte) 0x08;
    public static final byte TLV_OBJ_FIELD_HANDLE = (byte) 0x0E;
\
HW Info Format (sequence):

<table border="1">
<tr>
<td>Tag</td>
<td>Value Length (bytes)</td>
<td>Data Type</td>
<td>Value</td>
<td>TLV Entry</td>
</tr>
<tr>
<td>Version</td>
<td>2</td>
<td>byte[]</td>
<td>0x0100</td>
<td>FALSE</td>
</tr>
<tr>
<td>TLV_TAG_HW_CAP // HW Secure Input Capability</td>
<td>4</td>
<td>int</td>
<td>0x00 - No capability (i.e. secure keypad)</td>
<td>TRUE</td>
</tr>
<tr>
<td>TLV_TAG_HW_USR // User</td>
<td>1</td>
<td>byte</td>
<td>0x01 - Card Admin User</td>
<td>TRUE</td>
</tr>
<tr>
<td>TLV_TAG_HW_SCP // Secure Channel</td>
<td>1</td>
<td>byte</td>
<td>0x0A03 - Proprietary ThothTrust A03 SCP protocol</td>
<td>TRUE</td>
</tr>
<tr>
<td>TLV_TAG_HW_BK // HW Partition Backup Capability</td>
<td>0</td>
<td>N/A</td>
<td>N/A</td>
<td>TRUE</td>
</tr>
<tr>
<td>TLV_TAG_HW_INTERACT // HW Interactive Capability</td>
<td>1</td>
<td>byte</td>
<td>0x01 - Screen available</td>
<td>TRUE</td>
</tr>
<tr>
<td>TLV_TAG_HW_CRED_FORMAT // Credential Secret Format</td>
<td>1</td>
<td>byte</td>
<td>CRED_AUTHTYPE_PIN (0x80). Use numerical PIN only.</td>
<td>TRUE</td>
</tr>
<tr>
<td>TLV_TAG_HW_MEM_PERSIST // Persistent Memory</td>
<td>4</td>
<td>int</td>
<td></td>
<td>TRUE</td>
</tr>
<tr>
<td>TLV_TAG_HW_MEM_TEMP_RST // Temporary Resettable Memory</td>
<td>4</td>
<td>int</td>
<td></td>
<td>TRUE</td>
</tr>
<tr>
<td>TLV_TAG_HW_MEM_TEMP_DST // Temporary Deselectable Memory</td>
<td>4</td>
<td>int</td>
<td></td>
<td>TRUE</td>
</tr>
<tr>
<td>TLV_TAG_HW_ID // Hardware ID</td>
<td>0</td>
<td>nested tlv</td>
<td>N/A</td>
<td>TRUE</td>
</tr>
<tr>
<td>TLV_TAG_HW_ID_PUB // Hardware Public Key</td>
<td>variable</td>
<td>byte[]</td>
<td>Raw 64 bytes X || Y representation of non-exportable ECC-SECP256K1 public key for secure       channel and other hardware related PKI security for T104 environment</td>
<td>TRUE</td>
</tr>
</table>
<br>

Status Words:
<table border="1">
<tr>
<td>SW</td>
<td>Description</td>
</tr>
<tr>
<td>0x9000</td>
<td>No error</td>
</tr>
<tr>
<td>0x6999</td>
<td>Internal state error due to failed aplet initialization</td>
</tr>
</table>
<br>

### List AOC Container Information ###
Retrieves a byte array list of AOC slots

APDU Message Security:
<table border="1">
<tr>
<td>Require Enveloping Message</td>
<td>Require Un-enveloping Mesage</td>
</tr>
<tr>
<td>TRUE</td>
<td>TRUE</td>
</tr>
</table>
<br>

Request APDU:
<table border="1">
<tr>
<td>CLA</td>
<td>INS</td>
<td>P1</td>
<td>P2</td>
<td>LC</td>
<td>DATA</td>
<td>LE</td>
</tr>
<tr>
<td>84 (SECURE)</td>
<td>B2</td>
<td>01</td>
<td>00</td>
<td>00</td>
<td>N/A</td>
<td>N/A</td>
</tr>
</table>
<br>

Response APDU: \
Returns a byte array list of AOC slots. If the current byte us `00`, it is available. If the current byte is `01`, it is occupied. The returned length of the byte array list indicates the total available AOC container slots the T104 applet can provide.

An example is a 10 byte array return indicating a 10 slot capable AOC container storage as shown in the example below. Index #1 and #4 have `01` indicating slot `01` and slot `04` have AOC container occupied. 

<table border="1">
<tr>
<td>00</td>
<td>01</td>
<td>00</td>
<td>00</td>
<td>01</td>
<td>00</td>
<td>00</td>
<td>00</td>
<td>00</td>
<td>00</td>
</tr>
</table>
<br>

After requesting a list of AOC containers, it is highly advisable to follow up with a Get AOC Container Information method supplying the AOC container slot index to query more information about each AOC container slot.

Status Words:
<table border="1">
<tr>
<td>SW</td>
<td>Description</td>
</tr>
<tr>
<td>0x9000</td>
<td>No error</td>
</tr>
<tr>
<td>0x6999</td>
<td>Internal state error due to failed aplet initialization</td>
</tr>
</table>
<br>


### Get AOC Container Information ###
Retrieves information of AOC Container from slot index.

APDU Message Security:
<table border="1">
<tr>
<td>Require Enveloping Message</td>
<td>Require Un-enveloping Mesage</td>
</tr>
<tr>
<td>TRUE</td>
<td>TRUE</td>
</tr>
</table>
<br>

Request APDU:
<table border="1">
<tr>
<td>CLA</td>
<td>INS</td>
<td>P1</td>
<td>P2</td>
<td>LC</td>
<td>DATA</td>
<td>LE</td>
</tr>
<tr>
<td>84 (SECURE)</td>
<td>B2</td>
<td>02</td>
<td>00</td>
<td>01</td>
<td>Slot Index</td>
<td>N/A</td>
</tr>
</table>
<br>

Response APDU: \
Extracts the publicly available AOC container information. Does not require AOC container registration and login to access.

\
AOC Container Information Format (sequence):
<table border="1">
<tr>
<td>Tag</td>
<td>Value Length (bytes)</td>
<td>Data Type</td>
<td>Value</td>
<td>TLV Entry</td>
</tr>
<tr>
<td>TLV_TAG_AOC_CRED_ID // Registered AID</td>
<td>variable</td>
<td>byte[]</td>
<td>AID of registered applet to T104 AOC container</td>
<td>TRUE</td>
</tr>
<tr>
<td>TLV_TAG_AOC_AUXDATA // Auxilliary Data</td>
<td>variable</td>
<td>byte[]</td>
<td>0x30 - No E-Wallet access; 0x31 - Have E-Wallet access</td>
<td>TRUE</td>
</tr>
</table>
<br>

Status Words:
<table border="1">
<tr>
<td>SW</td>
<td>Description</td>
</tr>
<tr>
<td>0x9000</td>
<td>No error</td>
</tr>
<tr>
<td>0x6999</td>
<td>Internal state error due to failed aplet initialization</td>
</tr>
<tr>
<td>0x6700</td>
<td>Wrong length. Only 1-byte sot index is needed.</td>
</tr>
</table>
<br>

### Get T104 Applet Admin Login Retries Information ###
Retrieves the number of login retries left for T104 Applet administrator role without needing to login into the administrator role.

APDU Message Security:
<table border="1">
<tr>
<td>Require Enveloping Message</td>
<td>Require Un-enveloping Mesage</td>
</tr>
<tr>
<td>TRUE</td>
<td>TRUE</td>
</tr>
</table>
<br>

Request APDU:
<table border="1">
<tr>
<td>CLA</td>
<td>INS</td>
<td>P1</td>
<td>P2</td>
<td>LC</td>
<td>DATA</td>
<td>LE</td>
</tr>
<tr>
<td>84 (SECURE)</td>
<td>B2</td>
<td>04</td>
<td>01</td>
<td>00</td>
<td>N/A</td>
<td>01</td>
</tr>
</table>
<br>

Response APDU: \
Get the number of login retries left for T104 Applet administrator role. If `0xFF` is returned, incorrect P2 (incorrect role) was used in the query.

Status Words:
<table border="1">
<tr>
<td>SW</td>
<td>Description</td>
</tr>
<tr>
<td>0x9000</td>
<td>No error</td>
</tr>
<tr>
<td>0x6999</td>
<td>Internal state error due to failed aplet initialization</td>
</tr>
<tr>
<td>0x6FA1</td>
<td>Invalid user role in P2. P2 must be 0x01.</td>
</tr>
</table>
<br>

### Get Card Timeout ###
Retrieves the card timeout status. T104 Applet administrator role login is not required.

APDU Message Security:
<table border="1">
<tr>
<td>Require Enveloping Message</td>
<td>Require Un-enveloping Mesage</td>
</tr>
<tr>
<td>TRUE</td>
<td>TRUE</td>
</tr>
</table>
<br>

Request APDU:
<table border="1">
<tr>
<td>CLA</td>
<td>INS</td>
<td>P1</td>
<td>P2</td>
<td>LC</td>
<td>DATA</td>
<td>LE</td>
</tr>
<tr>
<td>84 (SECURE)</td>
<td>B2</td>
<td>05</td>
<td>00</td>
<td>00</td>
<td>N/A</td>
<td>02</td>
</tr>
</table>
<br>

Response APDU: \
A 2-byte short returned on the card timeout status. If `0` is returned, the card never times out. Other return values indicate a positive short value of timeout time on the card.


Status Words:
<table border="1">
<tr>
<td>SW</td>
<td>Description</td>
</tr>
<tr>
<td>0x9000</td>
<td>No error</td>
</tr>
<tr>
<td>0x6999</td>
<td>Internal state error due to failed aplet initialization</td>
</tr>
<tr>
<td>0x6F20</td>
<td>Retrieving card timeout timer has error. This is an internal error.</td>
</tr>
</table>
<br>

### Update AOC Container Information ###
Updates the AOC Container information. Currently only supports updating the access to E-Wallet function. T104 Administrator role login is required.

APDU Message Security:
<table border="1">
<tr>
<td>Require Enveloping Message</td>
<td>Require Un-enveloping Mesage</td>
</tr>
<tr>
<td>TRUE</td>
<td>TRUE</td>
</tr>
</table>
<br>

Request APDU:
<table border="1">
<tr>
<td>CLA</td>
<td>INS</td>
<td>P1</td>
<td>P2</td>
<td>LC</td>
<td>DATA</td>
<td>LE</td>
</tr>
<tr>
<td>84 (SECURE)</td>
<td>D2</td>
<td>00</td>
<td>00</td>
<td>00</td>
<td>TLV request sequence</td>
<td>02</td>
</tr>
</table>
<br>

AOC Container Information Format (sequence):
<table border="1">
<tr>
<td>Tag</td>
<td>Value Length (bytes)</td>
<td>Data Type</td>
<td>Value</td>
<td>TLV Entry</td>
</tr>
<tr>
<td>TLV_TAG_AOC_CRED_ID // Registered AID</td>
<td>variable</td>
<td>byte[]</td>
<td>AID of target registered applet to update information</td>
<td>TRUE</td>
</tr>
<tr>
<td>TLV_TAG_AOC_AUXDATA // Auxilliary Data</td>
<td>variable</td>
<td>byte[]</td>
<td>0x30 - Disable E-Wallet access; 0x31 - Enable E-Wallet access</td>
<td>TRUE</td>
</tr>
</table>
<br>

Response APDU: \
No response content.

Status Words:
<table border="1">
<tr>
<td>SW</td>
<td>Description</td>
</tr>
<tr>
<td>0x9000</td>
<td>No error</td>
</tr>
<tr>
<td>0x6999</td>
<td>Internal state error due to failed aplet initialization</td>
</tr>
<tr>
<td>0x6FA1</td>
<td>T104 Administrator role has not been logged in.</td>
</tr>
<tr>
<td>0x6984</td>
<td>Invalid data format for payload.</td>
</tr>
</table>
<br>

### Update T104 Applet Admin Login PIN ###
Perform update of T104 Applet administrator role PIN. T104 Administrator role login is required. PIN must be more than or equals to 6 digits long.

APDU Message Security:
<table border="1">
<tr>
<td>Require Enveloping Message</td>
<td>Require Un-enveloping Mesage</td>
</tr>
<tr>
<td>TRUE</td>
<td>TRUE</td>
</tr>
</table>
<br>

Request APDU:
<table border="1">
<tr>
<td>CLA</td>
<td>INS</td>
<td>P1</td>
<td>P2</td>
<td>LC</td>
<td>DATA</td>
<td>LE</td>
</tr>
<tr>
<td>84 (SECURE)</td>
<td>D2</td>
<td>01</td>
<td>00</td>
<td>PIN Length</td>
<td>PIN Code< in ASCIIfied numbers i.e. <code>0x313233343536</code> for numerical PIN of <code>123456</code></td>
<td>N/A</td>
</tr>
</table>
<br>

Response APDU: \
No response content.

Status Words:
<table border="1">
<tr>
<td>SW</td>
<td>Description</td>
</tr>
<tr>
<td>0x9000</td>
<td>No error</td>
</tr>
<tr>
<td>0x6999</td>
<td>Internal state error due to failed aplet initialization</td>
</tr>
<tr>
<td>0x6FA1</td>
<td>T104 Administrator role has not been logged in.</td>
</tr>
<tr>
<td>0x6985</td>
<td>Invalid data format for payload. New PIN must be 6 bytes or more.</td>
</tr>
</table>
<br>

### Update T104 Applet Card Timeout Status ###
Perform update to card timeout timer status. T104 Administrator role login is required. If `0xFFFF` is set for card timeout time, the card never times out. Otherwise, any card timeout time is in seconds. All card timeout time from `0x0000` (0 seconds) to `0x000A` (10 seconds) automatically is forced into `0x000A` (10 seconds) timeout time as the card has a minimum timeout time of 10 seconds and cannot be any lower than 10 seconds. The maximum timeout time is `0xFFFE` (65534 seconds).

APDU Message Security:
<table border="1">
<tr>
<td>Require Enveloping Message</td>
<td>Require Un-enveloping Mesage</td>
</tr>
<tr>
<td>TRUE</td>
<td>TRUE</td>
</tr>
</table>
<br>

Request APDU:
<table border="1">
<tr>
<td>CLA</td>
<td>INS</td>
<td>P1</td>
<td>P2</td>
<td>LC</td>
<td>DATA</td>
<td>LE</td>
</tr>
<tr>
<td>84 (SECURE)</td>
<td>D2</td>
<td>02</td>
<td>00</td>
<td>02</td>
<td>Card timer timeout in short type</code></td>
<td>N/A</td>
</tr>
</table>
<br>

Response APDU: \
No response content.

Status Words:
<table border="1">
<tr>
<td>SW</td>
<td>Description</td>
</tr>
<tr>
<td>0x9000</td>
<td>No error</td>
</tr>
<tr>
<td>0x6999</td>
<td>Internal state error due to failed aplet initialization</td>
</tr>
<tr>
<td>0x6FA1</td>
<td>T104 Administrator role has not been logged in.</td>
</tr>
<tr>
<td>0x6700</td>
<td>Wrong length for card timeout timing. It needs to be 2-byte short.</td>
</tr>
<tr>
<td>0x6F20</td>
<td>Setting card timeout timer has error. This is an internal error.</td>
</tr>
</table>
<br>

### Cleanup Orphaned AOC Containers ###
Cleanup orphaned AOC container slots. T104 Administrator role login is not required. Forces all AOC containers with non-existing applets on card to have their AOC container slots destroyed and freed.

APDU Message Security:
<table border="1">
<tr>
<td>Require Enveloping Message</td>
<td>Require Un-enveloping Mesage</td>
</tr>
<tr>
<td>TRUE</td>
<td>TRUE</td>
</tr>
</table>
<br>

Request APDU:
<table border="1">
<tr>
<td>CLA</td>
<td>INS</td>
<td>P1</td>
<td>P2</td>
<td>LC</td>
<td>DATA</td>
<td>LE</td>
</tr>
<tr>
<td>84 (SECURE)</td>
<td>0E</td>
<td>00</td>
<td>00</td>
<td>00</td>
<td>N/A</td>
<td>N/A</td>
</tr>
</table>
<br>

Response APDU: \
No response content.

Status Words:
<table border="1">
<tr>
<td>SW</td>
<td>Description</td>
</tr>
<tr>
<td>0x9000</td>
<td>No error</td>
</tr>
<tr>
<td>0x6999</td>
<td>Internal state error due to failed aplet initialization</td>
</tr>
<tr>
<td>0x6FA1</td>
<td>T104 Administrator role has not been logged in.</td>
</tr>
</table>
<br>

### Login to T104 Applet Admin Role ###
Login to T104 Applet administrator role. T104 Administrator role login is not required.

APDU Message Security:
<table border="1">
<tr>
<td>Require Enveloping Message</td>
<td>Require Un-enveloping Mesage</td>
</tr>
<tr>
<td>TRUE</td>
<td>TRUE</td>
</tr>
</table>
<br>

Request APDU:
<table border="1">
<tr>
<td>CLA</td>
<td>INS</td>
<td>P1</td>
<td>P2</td>
<td>LC</td>
<td>DATA</td>
<td>LE</td>
</tr>
<tr>
<td>84 (SECURE)</td>
<td>82</td>
<td>00</td>
<td>00</td>
<td>PIN Length</td>
<td>PIN Code< in ASCIIfied numbers i.e. <code>0x313233343536</code> for numerical PIN of <code>123456</code></td>
<td>N/A</td>
</tr>
</table>
<br>

Response APDU: \
No response content.

Status Words:
<table border="1">
<tr>
<td>SW</td>
<td>Description</td>
</tr>
<tr>
<td>0x9000</td>
<td>No error</td>
</tr>
<tr>
<td>0x6999</td>
<td>Internal state error due to failed aplet initialization</td>
</tr>
<tr>
<td>0x6700</td>
<td>Wrong length for PIN. PIN must not be 0 or less bytes.</td>
</tr>
<tr>
<td>0x6982</td>
<td>Incorect PIN or blocked Administrator role. Unable to login.</td>
</tr>
</table>
<br>

### WHOAMI ###
Checks the current logged in user(s) and statuses. T104 Administrator role login is not required.

APDU Message Security:
<table border="1">
<tr>
<td>Require Enveloping Message</td>
<td>Require Un-enveloping Mesage</td>
</tr>
<tr>
<td>TRUE</td>
<td>TRUE</td>
</tr>
</table>
<br>

Request APDU:
<table border="1">
<tr>
<td>CLA</td>
<td>INS</td>
<td>P1</td>
<td>P2</td>
<td>LC</td>
<td>DATA</td>
<td>LE</td>
</tr>
<tr>
<td>84 (SECURE)</td>
<td>82</td>
<td>FF</td>
<td>00</td>
<td>00</td>
<td>N/A</td>
<td>N/A</td>
</tr>
</table>
<br>

Response APDU: \
Return `0x01` to indicate T104 Applet administrator is logged in. Return `0x00` if no login has been done.

Status Words:
<table border="1">
<tr>
<td>SW</td>
<td>Description</td>
</tr>
<tr>
<td>0x9000</td>
<td>No error</td>
</tr>
<tr>
<td>0x6999</td>
<td>Internal state error due to failed aplet initialization</td>
</tr>
</table>
<br>

### Open Secure Channel - A03 ###
Opens a new Secure Channel session overriding any existing Secure Channel session. T104 Administrator role login is not required. Only 1 logical Secure Channel session is supported. An OTP Code is generated and displayed on E-Ink screen from the logical Secure Channel establishment and shown.

APDU Message Security:
<table border="1">
<tr>
<td>Require Enveloping Message</td>
<td>Require Un-enveloping Mesage</td>
</tr>
<tr>
<td>TRUE</td>
<td>TRUE</td>
</tr>
</table>
<br>

Request APDU:
<table border="1">
<tr>
<td>CLA</td>
<td>INS</td>
<td>P1</td>
<td>P2</td>
<td>LC</td>
<td>DATA</td>
<td>LE</td>
</tr>
<tr>
<td>88 (PLAIN)/ 84 (SECURE)</td>
<td>88</td>
<td>00</td>
<td>00</td>
<td>33</td>
<td>Uncompressed ASN.1 Host side ephemeral public key for SECP-256K1 (65 bytes)</code></td>
<td>N/A</td>
</tr>
</table>
<br>

Response APDU: \
No response content.

Status Words:
<table border="1">
<tr>
<td>SW</td>
<td>Description</td>
</tr>
<tr>
<td>0x9000</td>
<td>No error</td>
</tr>
<tr>
<td>0x6999</td>
<td>Internal state error due to failed aplet initialization</td>
</tr>
<tr>
<td>0x6700</td>
<td>Wrong length for Secure Channel Key Agreement. A 65-bytes ASN.1 encoded ECC-SECP256K1 public key has to be supplied.</td>
</tr>
</table>
<br>

### Logout of T104 Applet Admin Role ###
Logout of T104 Applet administrator role but does not close Secure Channel. T104 Administrator role login is not required.

APDU Message Security:
<table border="1">
<tr>
<td>Require Enveloping Message</td>
<td>Require Un-enveloping Mesage</td>
</tr>
<tr>
<td>TRUE</td>
<td>TRUE</td>
</tr>
</table>
<br>

Request APDU:
<table border="1">
<tr>
<td>CLA</td>
<td>INS</td>
<td>P1</td>
<td>P2</td>
<td>LC</td>
<td>DATA</td>
<td>LE</td>
</tr>
<tr>
<td>84 (SECURE)</td>
<td>FE</td>
<td>00</td>
<td>00</td>
<td>00</td>
<td>N/A</td>
<td>N/A</td>
</tr>
</table>
<br>

Response APDU: \
No response content.

Status Words:
<table border="1">
<tr>
<td>SW</td>
<td>Description</td>
</tr>
<tr>
<td>0x9000</td>
<td>No error</td>
</tr>
<tr>
<td>0x6999</td>
<td>Internal state error due to failed aplet initialization</td>
</tr>
</table>
<br>

## Other Status Words ##
Status Words:
<table border="1">
<tr>
<td>SW</td>
<td>Description</td>
</tr>
<tr>
<td>0x6FCC</td>
<td>Secure Channel initialization is required. Open Secure Channel protocol must be called.</td>
</tr>
<tr>
<td>0x6FCD</td>
<td>Issues occured when trying to process secure messages. Ensure messages are enveloped correctly.</td>
</tr>
<tr>
<td>0x6FE2</td>
<td>T104 Applet encounters an error when trying to envelope a secure response.</td>
</tr>
<tr>
<td>0x6E00</td>
<td>Invalid CLA byte.</td>
</tr>
<tr>
<td>0x6D00</td>
<td>Invalid INS byte.</td>
</tr>
<tr>
<td>0x6D00</td>
<td>Invalid INS byte.</td>
</tr>
<tr>
<td>0x6A86</td>
<td>Invalid P1 and/or P2 byte.</td>
</tr>
</table>
<br>

## Page Links ##
* [Product Overview](README.md)
* [Basic User Manual](Basic%20User%20Manual)
* [Developer Guide](Developer%20Guide)
* [Developer Samples Guide](Developer%20Samples%20Guide)
* [JavaDoc API](javadoc/index.html)
* [T104 Applet APDU Guide](T104%20Applet%20APDU%20Guide)